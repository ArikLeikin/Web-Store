<!DOCTYPE html>
<html>
  <head>
    <title>Playtopia|</title>
    <link rel="icon" type="image/x-icon" href="../images/favicon.png" />
    <link rel="stylesheet" href="../css/index.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.all.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="../js/index.js"></script>
    <script src="../js/manager.js"></script>
    <link rel="stylesheet" href="../css/manager.css" />
  </head>

  <body>
    <header class="header" role="banner">
      <div class="container">
        <nav class="navUser">
          <ul class="navUser-section">
            <li class="item__account" id="item__account">
              <a aria-label="Account" href="http://127.0.0.1:8080/login"
                ><img
                  src="../images/white-icons/account-icon.png"
                  alt="account"
                  width="30"
                />
              </a>
            </li>
            <li class="item__wishlist">
              <a aria-label="Wishlist" href="">
                <img
                  src="../images/white-icons/wishlist-icon.png"
                  alt="Cart"
                  width="30"
                />
              </a>
            </li>
            <li class="item__cart">
              <a href="http://127.0.0.1:8080/cart" aria-label="Cart">
                <img
                  src="../images/white-icons/cart-icon.png"
                  alt="Cart"
                  width="30"
                />
              </a>
            </li>
          </ul>
        </nav>

        <div class="header-logo">
          <a href="http://127.0.0.1:8080/" data-instantload='{"page":"home"}'>
            <div class="header-logo-image-container">
              <img
                class="header-logo-image"
                src="../images/logo.png"
                width="180"
                height="auto"
              />
            </div>
          </a>
        </div>

        <div class="quickSearch">
          <form class="form">
            <div class="form-container">
              <input
                class="form-input"
                data-search-quick
                name="search_query"
                id="search_query"
                data-error-message="Search field cannot be empty."
                placeholder="Search the store"
                autocomplete="off"
              />
              <button
                type="submit"
                class="button search-button"
                id="searchButton"
              >
                <img
                  src="../images/white-icons/search-icon.png"
                  alt="Search"
                  width="25"
                  height="auto"
                />
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Start Navigation Bar -->
      <nav class="navbar">
        <ul class="menu">
          <li>
            <a
              class="hasDropdown header-title"
              href="http://127.0.0.1:8080/products"
              >Categories <i class="fa fa-angle-down"></i
            ></a>

            <ul class="nav_container">
              <div class="container__list">
                <div class="container__listItem">
                  <div class="container__listItem_title">
                    <a
                      href="http://127.0.0.1:8080/products?category=boardgames"
                      class="sub-label-menu"
                      >Board Games</a
                    >
                  </div>
                </div>
                <div class="container__listItem">
                  <div class="container__listItem_title">
                    <a
                      href="http://127.0.0.1:8080/products?category=science"
                      class="sub-label-menu"
                      >Science</a
                    >
                  </div>
                </div>
                <div class="container__listItem">
                  <div class="container__listItem_title">
                    <a
                      href="http://127.0.0.1:8080/products?category=games"
                      class="sub-label-menu"
                      >Games</a
                    >
                  </div>
                </div>
                <div class="container__listItem">
                  <div class="container__listItem_title">
                    <a
                      href="http://127.0.0.1:8080/products?category=ridingtoys"
                      class="sub-label-menu"
                      >Riding Toys</a
                    >
                  </div>
                </div>
                <div class="container__listItem">
                  <div class="container__listItem_title">
                    <a
                      href="http://127.0.0.1:8080/products?category=puzzles"
                      class="sub-label-menu"
                      >Puzzles</a
                    >
                  </div>
                </div>
                <div class="container__listItem">
                  <div class="container__listItem_title">
                    <a
                      href="http://127.0.0.1:8080/products?category=musickaroke"
                      class="sub-label-menu"
                      >Music & Karaoke</a
                    >
                  </div>
                </div>
                <div class="container__listItem">
                  <div class="container__listItem_title">
                    <a
                      href="http://127.0.0.1:8080/products?category=books"
                      class="sub-label-menu"
                      >Books</a
                    >
                  </div>
                </div>
                <div class="container__listItem">
                  <div class="container__listItem_title">
                    <a
                      href="http://127.0.0.1:8080/products?category=lego"
                      class="sub-label-menu"
                      >Lego</a
                    >
                  </div>
                </div>
                <div class="container__listItem">
                  <div class="container__listItem_title">
                    <a
                      href="http://127.0.0.1:8080/products?category=dolls"
                      class="sub-label-menu"
                      >Dolls</a
                    >
                  </div>
                </div>
                <div class="container__listItem"></div>
                <div class="container__listItem"></div>

                <div class="container__listItem">
                  <div class="container__listItem_title bold no-underline">
                    <a
                      href="http://127.0.0.1:8080/products?category=10andbellow"
                      class="sub-label-menu"
                      >$10 & Below</a
                    >
                  </div>
                </div>
              </div>
            </ul>
          </li>
          <li>
            <a
              class="hasDropdown header-title"
              href="http://127.0.0.1:8080/products"
              >Ages<i class="fa fa-angle-down"></i
            ></a>
            <ul class="nav_container">
              <div class="container__list">
                <div class="container__listItem">
                  <div class="container__listItem_title">
                    <a
                      href="http://127.0.0.1:8080/products?age=0-12"
                      class="sub-label-menu"
                      >0-12 MONTHS</a
                    >
                  </div>
                </div>
                <div class="container__listItem">
                  <div class="container__listItem_title">
                    <a
                      href="http://127.0.0.1:8080/products?age=12-24"
                      class="sub-label-menu"
                      >12-24 MONTHS</a
                    >
                  </div>
                </div>
                <div class="container__listItem">
                  <div class="container__listItem_title">
                    <a
                      href="http://127.0.0.1:8080/products?age=2-4"
                      class="sub-label-menu"
                      >2-4 YEARS</a
                    >
                  </div>
                </div>
                <div class="container__listItem">
                  <div class="container__listItem_title">
                    <a
                      href="http://127.0.0.1:8080/products?age=5-7"
                      class="sub-label-menu"
                      >5-7 YEARS</a
                    >
                  </div>
                </div>
                <div class="container__listItem">
                  <div class="container__listItem_title">
                    <a
                      href="http://127.0.0.1:8080/products?age=8-99"
                      class="sub-label-menu"
                      >8-99 YEARS</a
                    >
                  </div>
                </div>
              </div>
            </ul>
          </li>
          <li>
            <a
              href="http://127.0.0.1:8080/products?category=outdoor"
              class="header-title"
              >Outdoor</a
            >
          </li>
          <li>
            <a
              href="http://127.0.0.1:8080/products?category=yad2"
              class="header-title"
              >Yad2</a
            >
          </li>
          <li>
            <a href="http://127.0.0.1:8080/Gift-Finder" class="header-title"
              >Gift Finder</a
            >
          </li>
        </ul>
      </nav>
      <!-- End Navigation Bar -->
    </header>
    <main style="margin-top: 150px">
      <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
      <h1 class="page-title center">Manager Dashboard</h1>

      <section id="content-management">
        <h2>Content Management:</h2>
        <p>
          In order to learn about the statistics of different age ranges in the
          countey according to areas - go to:
          <a href="../html/statistics.html">Statistics Page</a>
        </p>
        <!-- Need to add websocket managment -->
      </section>

      <h2>Users Management:</h2>
      <p>Add new user to the website:</p>

      <form  class =form id="add-user-form">
          <label for="firstName">First Name:</label>
          <input type="text" id="firstName" name="firstName" required />
          <div id="firstName-error" class="error-message"></div>
          <label for="lastName">Last Name:</label>
          <input type="text" id="lastName" name="lastName" required />
          <div id="lastName-error" class="error-message"></div>

          <label for="password">Password:</label>
          <input type="password" id="password" name="password" required />
          <div id="password-error" class="error-message"></div>

          <label for="email">Email:</label>
          <input type="email" id="email" name="email" />
          <div id="email-error" class="error-message"></div>
          <label for="phoneNumber">Phone Number:</label>
          <input type="text" id="phoneNumber" name="phoneNumber" />
          <div id="phoneNumber-error" class="error-message"></div>
  
        <button type="submit" id="add-button">Add User</button>
      </form>

      <table id="data-table">
        <thead>
          <tr>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Password</th>
            <th>Email</th>
            <th>Phone Number</th>
            <th>ID</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <script>
        $(document).ready(function () {
          const baseUrl = "http://127.0.0.1:8080"; // Base URL
          const tableBody = $("#data-table tbody");

          // Function to fetch users from the server
          function fetchUsers() {
            $.ajax({
              url: `${baseUrl}/api/users`,
              method: "GET",
              dataType: "json",
              success: function (data) {
                const users = data; // Assuming the array is directly in the response
                tableBody.empty(); // Clear the table body before adding new rows

                users.forEach(function (user) {
                  const row = createTableRow(user);
                  tableBody.append(row);
                });
              },
              error: function (error) {
                console.error("Error:", error);
              },
            });
          }

          // Initial fetching of users
          fetchUsers();

          // Function to create a table row
          function createTableRow(data) {
            const row = $("<tr>");
            row.append($("<td>").text(data.name.firstName));
            row.append($("<td>").text(data.name.lastName));
            row.append($("<td>").text(data.password));
            row.append($("<td>").text(data.email || "-"));
            row.append($("<td>").text(data.phoneNumber || "-"));
            row.append($("<td>").text(data._id));

            const deleteButton = $("<button>")
              .addClass("delete-button")
              .text("Delete User");
            deleteButton.data("userid", data._id);

            const actionCell = $("<td>").append(deleteButton);
            row.append(actionCell);
            return row;
          }

          // Function to add a new user
          function addUser(newUser) {
            $.ajax({
              url: `${baseUrl}/create/user`,
              method: "POST",
              data: newUser,
              dataType: "json",
              success: function () {
                fetchUsers(); // Refresh the user list after adding
              },
              error: function (error) {
                console.error("Error:", error);
              },
            });
          }

            $(document).ready(function () {
          $("#add-user-form").submit(function (event) {
            event.preventDefault();
            clearErrorMessages();
            let isValid = true;
        
            const FirstName = $("#firstName").val();
            if (!validateName(FirstName)) {
                 Swal.fire({
                icon: "warning",
                title: "Validation Error",
                text: "First name can only contain letters.",
              });
              //showError("#firstName-error", "First name can only contain letters.");
              isValid = false;
            }
        
            const LastName = $("#lastName").val();
            if (!validateName(LastName)) {
               Swal.fire({
              icon: "warning",
              title: "Validation Error",
              text: "Last name can only contain letters.",
            });
              //showError("#lastName-error", "Last name can only contain letters.");
              isValid = false;
            }
        
            const phone = $("#phoneNumber").val();
            if (!validatePhoneNumber(phone)) {
               Swal.fire({
                icon: "warning",
                title: "Validation Error",
                text: "Phone number must be 10 digits.",
               });
             // showError("#phoneNumber-error", "Phone number must be 10 digits.");
              isValid = false;
            }

            const password = $("#password").val();
            var passwordPattern = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^&*])(?=.{8,})/;
          if (!passwordPattern.test(password)) {
                  Swal.fire({
                    icon: "error",
                    title: "Invalid Password",
                    text: "Password must contain at least 8 characters, including 1 number, 1 uppercase letter, 1 lowercase letter, and 1 special character.",
                  });
            //showError("#password-error", "Password must contain at least 8 characters, including 1 number, 1 uppercase letter, 1 lowercase letter, and 1 special character.");
            isValid = false;
          }

          if (isValid) {
            const newUser = {
            firstName: $("#firstName").val(),
            lastName: $("#lastName").val(),
            email: $("#email").val(),
            phoneNumber: $("#phoneNumber").val(),
            password: $("#password").val(),
          };

          addUser(newUser);

          // Clear the form fields after submission
          $(this).trigger("reset");
                
                }

          });
      });

      function showError(element, message) {
        $(element).text(message).css("color", "red");
      }
      function clearErrorMessages() {
        $(".error-message").text("");
      }

      function validatePhoneNumber(phone) {
          return /^\d{10}$/.test(phone);
        }

        function validateName(str) {
          return /^[A-Za-z\s]+$/.test(str);
        }



          // // Add User Form submission event
          // $("#add-user-form").submit(function (event) {
          //   event.preventDefault();

          //   const newUser = {
          //     firstName: $("#firstName").val(),
          //     lastName: $("#lastName").val(),
          //     email: $("#email").val(),
          //     phoneNumber: $("#phoneNumber").val(),
          //     password: $("#password").val(),
          //   };

          //   addUser(newUser);

          //   // Clear the form fields after submission
          //   $(this).trigger("reset");
          // });

          // Function to delete a user
          function deleteUser(userId) {
            $.ajax({
              url: `${baseUrl}/delete/user/${userId}`, // Update the URL to the appropriate delete endpoint
              method: "POST",
              success: function () {
                fetchUsers(); // Refresh the user list after deletion
              },
              error: function (error) {
                console.error("Error:", error);
              },
            });
          }

          // Delete button click event
          tableBody.on("click", ".delete-button", function () {
            const userId = $(this).data("userid");
            if (confirm("Are you sure you want to delete this user?")) {
              deleteUser(userId);
            }
          });
        });
      </script>


      

      <h2>Products View:</h2>
      <script>
        $(document).ready(function () {
          $.ajax({
            url: "http://127.0.0.1:8080/api/products",
            type: "GET",
            dataType: "json",
            success: function (data) {
              populateTable(data);
            },
            error: function (xhr, status, error) {
              console.error("Error:", error);
            },
          });

          function populateTable(products) {
            var table = document.getElementById("productTable");

            products.forEach(function (product) {
              var row = table.insertRow();

              var fields = [
                "_id",
                "title",
                "price",
                "description",
                "image",
                "condition",
                "category",
                "manufacture_date",
                "supplier",
                "quantity",
                "age_range",
              ];

              fields.forEach(function (field) {
                var cell = row.insertCell();
                

                if (field === "image") {
                  cell.innerHTML = 
                    '<img src="' +  product[field] + '" width="100">';
                } else {
                  cell.innerHTML = product[field];
                }
              });
            });


           }
          });

      </script>

       <table id="productTable">
        <tr>
          <th>ID</th>
          <th>Title</th>
           <th>Price</th>
          <th>Description</th>
          <th>Image</th>
          <th>Condition</th>
          <th>Category</th>
          <th>Manufacture Date</th>
          <th>Supplier</th>
          <th>Quantity</th>
          <th>Age Range </th>
        </tr>
       </table>

      
      <div id="editModal" class="modal">
        <div class="modal-content"></div>
        <div class="modal-footer">
          <button id="saveChangesButton">Save Changes</button>
          <button id="closeModalButton">Close</button>
        </div>
      </div>
    </main>
  </body>
</html>
